<?xml version="1.0" encoding="UTF-8"?>

<!-- The Fuel file for the Fiat G-91R 3D model                       -->
<!-- License:  GNU GENERAL PUBLIC LICENSE Version 2, June 1991       -->
<!-- Author:  Patrizio Melis https://github.com/cobe571/Fiat-G-91R   -->

<system name="fuel"> 
  <!--
  General Info from the Fiat G-91R Flight Manual
  File explain from: http://wiki.flightgear.org/Howto:Write_a_fuel_system_in_JSBSim
  Forward Tank id = 0
  Aft Tank Right id = 1
  Aft Tank Left id = 2
  Auxiliary Tank Right (Droppable fuel tank) id = 3
  Auxiliary Tank Left (Droppable fuel tank) id = 4
  Collector or Manifold Tank id = 5
  The drop tank (3-4) if there are, fill the internal tanks (0) (1-2), in turn tanks (1-2) are kept level.
  The tank (5) is fed through a specially balancing valve that connects to the tanks (0) and (1-2).
  The tank (6) is the collector tank for (3) and (4)
  -->
  
  <!-- Collector Tank 6 level-maintenance for droppable tank 3-4 -->
  <channel name="To Tank6">
    <!-- from Tank 3 (to Collector Tank 6) -->
    <switch name="fuel/from-tank3-to-tank6">
      <default value="0"/>
      <test logic="AND" value="3">
	propulsion/tank[3]/priority EQ 1 
	propulsion/tank[3]/contents-lbs GT 0
	/consumables/fuel/tank[6]/level-lbs LT 9
	propulsion/tank[6]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>

    <!-- from Tank 4 (to Collector Tank 6) -->
    <switch name="fuel/from-tank4-to-tank6">
      <default value="0"/>
      <test logic="AND" value="3">
	propulsion/tank[4]/priority EQ 1 
	propulsion/tank[4]/contents-lbs GT 0
	/consumables/fuel/tank[6]/level-lbs LT 9
	propulsion/tank[6]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>
  </channel>
  
  <!-- Total flux from Tank 3 and 4 to Tank 3 -->
  <channel name="Total flow rates">
    <summer name="fuel/tank3-flow-rate">
      <input>-fuel/from-tank3-to-tank6</input>
      <output>propulsion/tank[3]/external-flow-rate-pps</output>
    </summer>
    <summer name="fuel/tank4-flow-rate">
      <input>-fuel/from-tank4-to-tank6</input>
      <output>propulsion/tank[4]/external-flow-rate-pps</output>
    </summer>
  </channel>

  <!-- Total flux for Tank 6 -->
  <channel name="Total flow rate into tank 6">
    <summer name="tank3 and tank4 to tank6">
      <input>fuel/from-tank3-to-tank6</input>
      <input>fuel/from-tank4-to-tank6</input>
      <input>-fuel/from-tank6-to-tank0</input>
      <input>-fuel/from-tank6-to-tank1</input>
      <input>-fuel/from-tank6-to-tank2</input>
      <output>propulsion/tank[6]/external-flow-rate-pps</output>
    </summer>
  </channel>
  
  <channel name="To Tank0">
    <!-- from Collector Tank 6 to Tank0 -->
    <switch name="fuel/from-tank6-to-tank0">
      <default value="0"/>
      <test logic="AND" value="3">
	propulsion/tank[6]/priority EQ 1 
	propulsion/tank[6]/contents-lbs GT 5
	/consumables/fuel/tank[0]/level-lbs LT 1366
	propulsion/tank[0]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>
  </channel>
  
  <!-- Total from Collector Tank 6 to Tank 0 -->
  <channel name="Total flow rate into tank 0">
    <summer name="tank6 to tank0">
      <input>fuel/from-tank6-to-tank0</input>
      <input>-fuel/from-tank0-to-tank5</input>
      <output>propulsion/tank[0]/external-flow-rate-pps</output>
    </summer>
  </channel>
  
  <channel name="To Tank1">
    <!-- from Collector Tank 6 to Tank1 -->
    <switch name="fuel/from-tank6-to-tank1">
      <default value="0"/>
      <test logic="AND" value="1.5">
	propulsion/tank[6]/priority EQ 1 
	propulsion/tank[6]/contents-lbs GT 5
	/consumables/fuel/tank[1]/level-lbs LT 561
	propulsion/tank[1]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>
  </channel>
  
  <!-- Total from Collector Tank 6 to Tank 1 -->
  <channel name="Total flow rate into tank 1">
    <summer name="tank6 to tank1">
      <input>fuel/from-tank6-to-tank1</input>
      <input>-fuel/from-tank1-to-tank7</input>
      <output>propulsion/tank[1]/external-flow-rate-pps</output>
    </summer>
  </channel>
  
  <channel name="To Tank2">
    <!-- from Collector Tank 6 to Tank2 -->
    <switch name="fuel/from-tank6-to-tank2">
      <default value="0"/>
      <test logic="AND" value="1.5">
	propulsion/tank[6]/priority EQ 1 
	propulsion/tank[6]/contents-lbs GT 5
	/consumables/fuel/tank[2]/level-lbs LT 561
	propulsion/tank[2]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>
  </channel>
  
  <!-- Total from Collector Tank 6 to Tank 2 -->
  <channel name="Total flow rate into tank 2">
    <summer name="tank6 to tank2">
      <input>fuel/from-tank6-to-tank2</input>
      <input>-fuel/from-tank2-to-tank7</input>
      <output>propulsion/tank[2]/external-flow-rate-pps</output>
    </summer>
  </channel>
  
  <!-- Collector Tank 7 level-maintenance for tank 1-2 -->
  <channel name="To Tank7">
    <!-- from Tank 1 (to Collector Tank 7) -->
    <switch name="fuel/from-tank1-to-tank7">
      <default value="0"/>
      <test logic="AND" value="1">
	propulsion/tank[1]/priority EQ 1 
	propulsion/tank[1]/contents-lbs GT 0
	/consumables/fuel/tank[7]/level-lbs LT 9
	propulsion/tank[7]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>

    <!-- from Tank 2 (to Collector Tank 7) -->
    <switch name="fuel/from-tank2-to-tank7">
      <default value="0"/>
      <test logic="AND" value="1">
	propulsion/tank[2]/priority EQ 1 
	propulsion/tank[2]/contents-lbs GT 0
	/consumables/fuel/tank[7]/level-lbs LT 9
	propulsion/tank[7]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>
  </channel>
  
  <!-- Total flux for Tank 7 -->
  <channel name="Total flow rate into tank 7">
    <summer name="tank1 and tank2 to tank7">
      <input>fuel/from-tank1-to-tank7</input>
      <input>fuel/from-tank2-to-tank7</input>
      <input>-fuel/from-tank7-to-tank5</input>
      <output>propulsion/tank[7]/external-flow-rate-pps</output>
    </summer>
  </channel>
  
  <!-- Collector Tank 5 level-maintenance for tank 0-7 -->
  <!-- Note:
    The values assigned to:
    fuel/from-tank0-to-tank5
    fuel/from-tank7-to-tank5
    They must be calibrated appropriately to simulate the mixing device used by heating it.
    Theoretically it should not change the weight relation Tank0 with Tank1+Tank2
  -->
  <channel name="To Tank5">
    <!-- from Tank 0 (to Collector Tank 5) -->
    <switch name="fuel/from-tank0-to-tank5">
      <default value="0"/>
      <test logic="AND" value="1">
	propulsion/tank[0]/priority EQ 1 
	propulsion/tank[0]/contents-lbs GT 0
	/consumables/fuel/tank[5]/level-lbs LT 276
	propulsion/tank[5]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>

    <!-- from Tank 7 (to Collector Tank 5) -->
    <switch name="fuel/from-tank7-to-tank5">
      <default value="0"/>
      <test logic="AND" value="1">
	propulsion/tank[7]/priority EQ 1 
	propulsion/tank[7]/contents-lbs GT 0
	/consumables/fuel/tank[5]/level-lbs LT 276
	propulsion/tank[5]/priority EQ 1
	accelerations/Nz GE -0.5
      </test>
    </switch>
  </channel>
  
  <!-- Total flux for Tank 5 -->
  <channel name="Total flow rate into tank 5">
    <summer name="tank0 and tank7 to tank5">
      <input>fuel/from-tank0-to-tank5</input>
      <input>fuel/from-tank7-to-tank5</input>
      <output>propulsion/tank[5]/external-flow-rate-pps</output>
    </summer>
  </channel>  
  
</system>